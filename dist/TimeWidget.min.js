// undefined v0.0.25 Copyright 2025 Iván Velasco González & John Alexis Guerra Gómez
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3")):"function"==typeof define&&define.amd?define(["d3"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).TimeWidget=t(e.d3)}(this,(function(e){"use strict";function t(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var o=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,o.get?o:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var n=t(e);function o(e){if(null===e||!0===e||!1===e)return NaN;var t=Number(e);return isNaN(t)?t:t<0?Math.ceil(t):Math.floor(t)}function r(e,t){if(t.length<e)throw new TypeError(e+" argument"+(e>1?"s":"")+" required, but only "+t.length+" present")}function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}function a(e){r(1,arguments);var t=Object.prototype.toString.call(e);return e instanceof Date||"object"===i(e)&&"[object Date]"===t?new Date(e.getTime()):"number"==typeof e||"[object Number]"===t?new Date(e):("string"!=typeof e&&"[object String]"!==t||"undefined"==typeof console||(console.warn("Starting with v2.0.0-beta.1 date-fns doesn't accept strings as date arguments. Please use `parseISO` to parse strings. See: https://github.com/date-fns/date-fns/blob/master/docs/upgradeGuide.md#string-arguments"),console.warn((new Error).stack)),new Date(NaN))}function l(e,t){r(2,arguments);var n=a(e),i=o(t);return isNaN(i)?new Date(NaN):i?(n.setDate(n.getDate()+i),n):n}function s(e,t){r(2,arguments);var n=a(e),i=o(t);if(isNaN(i))return new Date(NaN);if(!i)return n;var l=n.getDate(),s=new Date(n.getTime());s.setMonth(n.getMonth()+i+1,0);var c=s.getDate();return l>=c?s:(n.setFullYear(s.getFullYear(),s.getMonth(),l),n)}function c(e){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c(e)}function u(e,t){if(r(2,arguments),!t||"object"!==c(t))return new Date(NaN);var n=t.years?o(t.years):0,i=t.months?o(t.months):0,u=t.weeks?o(t.weeks):0,d=t.days?o(t.days):0,h=t.hours?o(t.hours):0,f=t.minutes?o(t.minutes):0,p=t.seconds?o(t.seconds):0,g=a(e),m=i||n?s(g,i+12*n):g,b=d||u?l(m,d+7*u):m,v=f+60*h,y=p+60*v,w=1e3*y,x=new Date(b.getTime()+w);return x}function d(e){var t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()));return t.setUTCFullYear(e.getFullYear()),e.getTime()-t.getTime()}function h(e){r(1,arguments);var t=a(e);return t.setHours(0,0,0,0),t}var f=864e5;function p(e,t){r(2,arguments);var n=h(e),o=h(t),i=n.getTime()-d(n),a=o.getTime()-d(o);return Math.round((i-a)/f)}function g(e,t){r(2,arguments);var n=a(e),o=a(t),i=n.getTime()-o.getTime();return i<0?-1:i>0?1:i}var m=36e5;function b(e,t){r(2,arguments);var n=a(e),o=a(t),i=n.getFullYear()-o.getFullYear(),l=n.getMonth()-o.getMonth();return 12*i+l}function v(e,t){r(2,arguments);var n=a(e),o=a(t);return n.getFullYear()-o.getFullYear()}function y(e,t){var n=e.getFullYear()-t.getFullYear()||e.getMonth()-t.getMonth()||e.getDate()-t.getDate()||e.getHours()-t.getHours()||e.getMinutes()-t.getMinutes()||e.getSeconds()-t.getSeconds()||e.getMilliseconds()-t.getMilliseconds();return n<0?-1:n>0?1:n}function w(e,t){r(2,arguments);var n=a(e),o=a(t),i=y(n,o),l=Math.abs(p(n,o));n.setDate(n.getDate()-i*l);var s=Number(y(n,o)===-i),c=i*(l-s);return 0===c?0:c}function x(e,t){return r(2,arguments),a(e).getTime()-a(t).getTime()}var S={ceil:Math.ceil,round:Math.round,floor:Math.floor,trunc:function(e){return e<0?Math.ceil(e):Math.floor(e)}};function k(e){return e?S[e]:S.trunc}function C(e,t,n){r(2,arguments);var o=x(e,t)/m;return k(null==n?void 0:n.roundingMethod)(o)}function B(e,t,n){r(2,arguments);var o=x(e,t)/6e4;return k(null==n?void 0:n.roundingMethod)(o)}function A(e){r(1,arguments);var t=a(e);return t.setHours(23,59,59,999),t}function M(e){r(1,arguments);var t=a(e),n=t.getMonth();return t.setFullYear(t.getFullYear(),n+1,0),t.setHours(23,59,59,999),t}function _(e){r(1,arguments);var t=a(e);return A(t).getTime()===M(t).getTime()}function E(e,t){r(2,arguments);var n,o=a(e),i=a(t),l=g(o,i),s=Math.abs(b(o,i));if(s<1)n=0;else{1===o.getMonth()&&o.getDate()>27&&o.setDate(30),o.setMonth(o.getMonth()-l*s);var c=g(o,i)===-l;_(a(e))&&1===s&&1===g(e,i)&&(c=!1),n=l*(s-Number(c))}return 0===n?0:n}function T(e,t,n){r(2,arguments);var o=x(e,t)/1e3;return k(null==n?void 0:n.roundingMethod)(o)}function G(e,t){r(2,arguments);var n=a(e),o=a(t),i=g(n,o),l=Math.abs(v(n,o));n.setFullYear(1584),o.setFullYear(1584);var s=g(n,o)===-i,c=i*(l-Number(s));return 0===c?0:c}function D(e){r(1,arguments);var t=a(e.start),n=a(e.end);if(isNaN(t.getTime()))throw new RangeError("Start Date is invalid");if(isNaN(n.getTime()))throw new RangeError("End Date is invalid");var o={};o.years=Math.abs(G(n,t));var i=g(n,t),l=u(t,{years:i*o.years});o.months=Math.abs(E(n,l));var s=u(l,{months:i*o.months});o.days=Math.abs(w(n,s));var c=u(s,{days:i*o.days});o.hours=Math.abs(C(n,c));var d=u(c,{hours:i*o.hours});o.minutes=Math.abs(B(n,d));var h=u(d,{minutes:i*o.minutes});return o.seconds=Math.abs(T(n,h)),o}function N(e,t){r(2,arguments);var n=o(t);return l(e,-n)}function $(e,t){r(2,arguments);var n=o(t);return s(e,-n)}function L(e){return L="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},L(e)}function Y(e,t){if(r(2,arguments),!t||"object"!==L(t))return new Date(NaN);var n=t.years?o(t.years):0,i=t.months?o(t.months):0,a=t.weeks?o(t.weeks):0,l=t.days?o(t.days):0,s=t.hours?o(t.hours):0,c=t.minutes?o(t.minutes):0,u=t.seconds?o(t.seconds):0,d=$(e,i+12*n),h=N(d,l+7*a),f=c+60*s,p=u+60*f,g=1e3*p,m=new Date(h.getTime()-g);return m}let R=0;function P(){console.log(performance.now()-R,...arguments),R=performance.now()}function j(e,t=1){const{l:o,c:r,h:i}=n.lch(e);return n.lch(o-18*t,r,i)}function X(e,t){if(e===t)return!0;if(null===e)return!1;if(null===t)return!1;if(e.size!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;return!0}function z(e,t,n){let o=t.domain(),r=n.domain(),i=[e[0][0],e[1][0]],a=[e[1][1],e[0][1]];return i[0]>o[0]&&i[1]<o[1]&&a[0]>r[0]&&a[1]<r[1]}const O=Object.freeze({changeSelection:"changeSelection",addBrushGroup:"newBrushGroup",removeBrushGroup:"deleteBrushGroup",selectBrushGroup:"selectBrushGroup",changeNonSelected:"changeNonSelected",changeBrushGroupState:"changeBrushGroupState",deselectAllBrushes:"deselectAllBrushes",highlightSelection:"highlightSelection",update:"update"}),H=Object.freeze({Intersect:"intersect",Contains:"contains"}),F=Object.freeze({And:"and",Or:"OR"});function I({ts:e,detailsElement:t,detailsContainerHeight:o,detailsWidth:r,maxDetailsRecords:i,detailsHeight:a,x:l,y:s,margin:c={left:50,top:10,bottom:20,right:0}}={}){const u={};let d=new Map;const h=n.select(t).attr("id","detail").style("height",`${o}px`).style("width",`${r}px`).style("overflow-y","scroll").node(),f=n.line().defined((e=>void 0!==s(e)&&null!==s(e)));let p,g;function m({data:e,brushGroupSelected:t}){let o=i?e.get(t).slice(0,i):e.get(t);h.innerHTML="",n.select(h).selectAll("div.detailsContainer").data(o,(e=>e[0])).join("div").attr("class","detailsContainer").attr("group",(e=>e[0])).each((function(e){!function({points:e=[],width:t=600,height:o=300,margin:r={top:10,left:40,right:10,bottom:10},xScale:i=n.scaleLinear().range([0,t]),yScale:a=n.scaleLinear().range([o,0]),x:l=(e=>e[0]),y:s=(e=>e[1]),line:c=n.line(),title:u="",target:d=null,renderer:h="canvas",pointRadius:f=1.5,strokeColor:p="#777"}={}){let g=(d?n.select(d):n.create("div")).attr("class","details").style("position","relative");g.selectAll("*").remove();let m=g.append("canvas").style("position","absolute").style("top",`${r.top}px`).style("left",`${r.left}px`).style("height",o+"px").style("width",t+"px").style("pointer-events","none"),b=m.node().getContext("2d");const v=window.devicePixelRatio||1;m.attr("height",Math.floor(o*v)).attr("width",Math.floor(t*v)),b.scale(v,v);let y=g.append("svg").attr("viewBox",[0,0,t,o]).attr("height",o).attr("width",t).append("g").attr("class","gDrawing").attr("transform",`translate(${r.left}, ${r.top})`);if(y.append("g").attr("class","detailsYAxis").call(n.axisLeft(a).ticks(Math.floor(o/30))),y.append("g").attr("class","detailsXAxis").call(n.axisBottom(i)).attr("transform",`translate(0, ${o-r.top-r.bottom})`),y.append("text").text(u).attr("transform","translate(10, 0)").style("fill",p).style("font-size","0.7em"),"SVG"==h.toUpperCase())y.append("path").attr("d",c(e)).style("fill","none").style("stroke",p),y.append("points").selectAll("circle").data(e).join("circle").attr("cx",(e=>i(l(e)))).attr("cx",(e=>i(l(e)))).attr("r",f).attr("stroke",p);else{let t=new Path2D(c(e));b.strokeStyle=p,b.stroke(t),b.beginPath();for(let t of e)b.moveTo(i(l(t))+f,a(s(t))+f),b.arc(i(l(t)),a(s(t)),f,0,2*Math.PI);b.stroke()}}({target:this,width:r,height:a,margin:c,yScale:g,xScale:p,x:l,y:s,title:e[0],points:e[1],line:f})}))}return u.setScales=function({overviewX:e,overviewY:t}){p=e.copy(),p.range([0,r-c.right-c.left]),g=t.copy(),g.range([a-c.top-c.bottom,0]).nice().clamp(!0),f.x((e=>p(+l(e)))).y((e=>g(s(e))))},u.generatePrerenderDetails=function(e){return d=new Map,d},u.render=({data:e,brushGroupSelected:t})=>m({data:e,brushGroupSelected:t}),u}function W({ts:e,element:t,width:o=800,height:r=600,x:i,y:a,groupAttr:l}){let s,c,u,d={};const h=n.select(t).style("display","flex").style("flex-wrap","wrap").style("position","relative").style("top","0px").style("left","0px").style("background-color",e.backgroundColor);let f=n.line().defined((e=>void 0!==a(e)&&null!==a(e))),p=n.line();const g=h.selectAll("canvas").data([1]).join("canvas").attr("height",r*window.devicePixelRatio).attr("width",o*window.devicePixelRatio).style("position","absolute").style("z-index","-1").style("top",`${e.margin.top}px`).style("left",`${e.margin.left}px`).style("width",`${o}px`).style("height",`${r}px`).style("pointer-events","none"),m=g.node().getContext("2d");function b(t,n){return void 0!==n||e.brushesColorScale instanceof Array?e.brushesColorScale[t](n):e.brushesColorScale(t)}function v(t,n,o,r=null){if(t){m.globalAlpha=n*e.alphaScale(t.length);for(let n of t){let t=s.get(n[0]);if(!t)return void console.log("renderOverviewCanvasSubset error finding path",n[0],n);let i=o;if(l){const n=e.colorScale(t.group);i=e.selectedColorTransform(n,r)}m.strokeStyle=""+i,m.stroke(t.path)}}else console.log("🚫 Error renderOverviewCanvasSubset called with no dataSubset",t)}return m.scale(window.devicePixelRatio,window.devicePixelRatio),d.data=function(e){s=new Map,e.forEach((e=>{let t=l?l(e[1][0]):null,n={path:new Path2D(f(e[1])),group:t};s.set(e[0],n)}))},d.setScales=function({scaleX:e,scaleY:t}){c=e,u=t,f=f.x((e=>c(+i(e)))).y((e=>u(a(e)))),p=p.x((e=>c(e[0]))).y((e=>u(e[1])))},d.render=function(t,n,o,r,i,a,l){!function(t,n,o,r,i,a=[],l,s){if(o=o||[],m.clearRect(0,0,g.node().width,g.node().height),i){if(m.lineWidth=1,v(o,e.noSelectedAlpha,e.noSelectedColor),t.forEach(((t,o)=>{if(o!==n){let n=b(o,l);console.log("Render selected selectedColor",n,o,l),v(t,e.selectedAlpha,n.toString(),o)}})),v(t.get(n),e.selectedAlpha,b(n,l).toString(),n),s){let t=s.positionTs,n=s.groupId;if(t!==l&&a[t]&&a[t].has(n)){let o=b(n,t);v(a[t].get(n),e.highlightAlpha,o,n)}}m.save(),r&&(m.lineWidth=e.medianLineWidth,m.globalAlpha=e.medianLineAlpha,r.forEach((t=>{if(!t[1])return void console.log("Error drawing medians, empty data",t);let n=new Path2D(p(t[1]));m.setLineDash(e.medianLineDash),m.strokeStyle=j(b(t[0],l)),m.stroke(n)}))),m.restore()}else v(o,e.defaultAlpha,e.defaultColor)}(t,n,o,r,i,a,l)},d}function U(e,t,n){var o,r=n||{},i=r.noTrailing,a=void 0!==i&&i,l=r.noLeading,s=void 0!==l&&l,c=r.debounceMode,u=void 0===c?void 0:c,d=!1,h=0;function f(){o&&clearTimeout(o)}function p(){for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];var l=this,c=Date.now()-h;function p(){h=Date.now(),t.apply(l,r)}function g(){o=void 0}d||(s||!u||o||p(),f(),void 0===u&&c>e?s?(h=Date.now(),a||(o=setTimeout(u?g:p,e))):p():!0!==a&&(o=setTimeout(u?g:p,void 0===u?e-c:e)))}return p.cancel=function(e){var t=(e||{}).upcomingOnly,n=void 0!==t&&t;f(),d=!n},p}function V({data:e,xPartitions:t=10,yPartitions:o=10,polylines:r=!0}){let i={},a=s(),l=null;function s(){let i=e.map((e=>e[0])),a=e.map((e=>e[1])).flat(),l=n.extent(a,(e=>e[0])),s=n.extent(a,(e=>e[1])),c=l[1]-l[0]+1,u=s[1]-s[0]+1,d=c/t,h=u/o,f={width:c,height:u,xinc:d,yinc:h,offsetX:l[0],offsetY:s[0],keys:i,BVH:[]};for(let e=0;e<t;++e){f.BVH[e]=[];let t=e*d;for(let n=0;n<o;++n){let o=h*n;f.BVH[e][n]={x0:t,x1:t+d,y0:o,y1:o+h,data:new Map}}}return e=e.map((([e,t])=>[e,t.map((([e,t])=>[e-f.offsetX,t-f.offsetY]))])),r?function(e,t){let n=t.xinc,o=t.yinc;e.forEach((e=>{let r=e[0],i=-1,a=-1;for(let l=0;l<e[1].length;++l){let s=e[1][l],c=s[0],u=s[1];if(null!=c&&null!=u){let d=Math.floor(c/n),h=Math.floor(u/o);if((isNaN(d)||isNaN(h))&&P("ERROR: xIndex or YIndex is NaN: XCoor: "+c+"; yCoor: "+u),0===l)t.BVH[d][h].data.set(r,[[s]]);else if(d===i&&h===a)t.BVH[d][h].data.get(r).at(-1).push(s);else{let n=t.BVH[i][a];n.data.get(r).at(-1).push(s);let o=e[1][l-1];for(let e of t.BVH)for(let t of e)t!==n&&p([o,s],t.x0,t.y0,t.x1,t.y1)&&(t.data.has(r)?(t.data.get(r).push([o]),t.data.get(r).at(-1).push(s)):(t.data.set(r,[[o]]),t.data.get(r).at(-1).push(s)))}i=d,a=h}}}))}(e,f):function(e,t){let n=t.xinc,o=t.yinc;e.forEach((e=>{let r=e[0];for(let i of e[1]){let[e,a]=i,l=Math.floor(e/n),s=Math.floor(a/o),c=t.BVH[l][s];c.data.has(r)?c.data.get(r).push([e,a]):c.data.set(r,[e,a])}}))}(e,f),f}function c(e,t,n,o,r){let[i,a]=e;return i>=t&&i<=o&&a>=n&&a<=r}function u(e,t,n,o,r,i){if(e[0]<=n&&t[0]>=n||e[0]>=n&&t[0]<=n){let r=(t[1]-e[1])/(t[0]-e[0])*(n-e[0])+e[1];return r>=o&&r<=i}return!1}function d(e,t,n,o,r,i){if((e[0]<=r&&t[0])>=r||e[0]>=r&&t[0]<=r){let n=(t[1]-e[1])/(t[0]-e[0])*(r-e[0])+e[1];return n>=o&&n<=i}return!1}function h(e,t,n,o,r,i){if(e[1]<=o&&t[1]>=o||e[1]>=o&&t[1]<=o){let i=(t[1]-e[1])/(t[0]-e[0]),a=(o-e[1])/i+e[0];return a>=n&&a<=r}return!1}function f(e,t,n,o,r,i){if(e[1]>=i&&t[1]<=i||e[1]<=i&&t[1]>=i){let o=(t[1]-e[1])/(t[0]-e[0]),a=(i-e[1])/o+e[0];return a>=n&&a<=r}return!1}function p(e,t,n,o,r){let i=e[0];for(let a=1;a<e.length;++a){let l=e[a];if(u(i,l,t,n,0,r))return!0;if(d(i,l,0,n,o,r))return!0;if(h(i,l,t,n,o))return!0;if(f(i,l,t,0,o,r))return!0;i=l}return c(i,t,n,o,r)}function g(e,t,n,o,r){let i=e[0],a=e[e.length-1],l=!1,s=!1;if(!(i[0]<t&&a[0]<t||i[0]>o&&a[0]>o)){for(let a=1;a<e.length;++a){let c=e[a];if((l||u(i,c,t,n,0,r))&&(l=!0),(s||d(i,c,0,n,o,r))&&(s=!0),h(i,c,t,n,o))return!1;if(f(i,c,t,0,o,r))return!1;i=c}return!(!l&&!s)||c(e[0],t,n,o,r)}}function m(e,t,n,o){return(n>a.width||o>a.height||e<0||t<0)&&P("👁️ BVH is called off limits",[[e,t],[n,o]]),n=Math.min(n,a.width-1),o=Math.min(o,a.height-1),e=Math.max(e,0),t=Math.max(t,0),[[Math.floor(e/a.xinc),Math.floor(n/a.xinc)],[Math.floor(t/a.yinc),Math.floor(o/a.yinc)]]}function b(e,t,n,o){return[e-a.offsetX,t-a.offsetY,n-a.offsetX,o-a.offsetY]}function v(e){if(!l)return!1;let{x0:t,y0:n,x1:o,y1:r}=e;if("vertical"===l.type){let e=l.x;return e>=t&&e<=o}{let e=l.slope,i=l.intercept,a=e*t+i;if(a>=n&&a<=r)return!0;let s=e*o+i;if(s>=n&&s<=r)return!0;if(0!==e){let r=(n-i)/e;if(r>=t&&r<=o)return!0}if(0!==e){let n=(r-i)/e;if(n>=t&&n<=o)return!0}let c=e*t+i,u=e*o+i;if(c<n&&u>r||c>r&&u<n)return!0}return!1}function y(e){if(!l||e.length<2)return!1;for(let t=0;t<e.length-1;t++){let[n,o]=e[t],[r,i]=e[t+1];if("vertical"===l.type){let e=l.x;if(n<=e&&r>=e||n>=e&&r<=e)return!0}else{let e=l.slope,t=l.intercept;if((e*n-o+t)*(e*r-i+t)<=0)return!0}}return!1}return l={type:"slope-intercept",slope:.5,intercept:0},console.log("📏 Example static line loaded: y = 0.5x + 0"),e&&0!==e.length||(console.log("📝 Using example data for testing..."),e=[["test1",[[0,0],[10,5],[20,10]]],["test2",[[5,15],[15,8],[25,12]]],["test3",[[0,10],[30,10]]]],a=s()),setTimeout((()=>{e.length<=3&&i.testStaticLineFunctionality()}),100),i.contains=function(e,t,n,o){return function(e,t,n,o,r){[e,t,n,o]=b(e,t,n,o);let[[i,l],[s,c]]=m(e,t,n,o),u=new Set,d=new Set;for(let h=i;h<=l;++h)for(let i=s;i<=c;++i)for(const l of a.BVH[h][i].data)if(!d.has(l[0]))for(const i of l[1]){let a=r(i,e,t,n,o);void 0!==a&&(a?u.add(l[0]):d.add(l[0]))}return d.forEach((e=>u.delete(e))),u}(e,t,n,o,g)},i.intersect=function(e,t,n,o){return function(e,t,n,o,r){[e,t,n,o]=b(e,t,n,o);let[[i,l],[s,c]]=m(e,t,n,o),u=new Set;for(let d=i;d<=l;++d)for(let i=s;i<=c;++i)for(const l of a.BVH[d][i].data)if(!u.has(l[0]))for(const i of l[1])if(r(i,e,t,n,o)){u.add(l[0]);break}return u}(e,t,n,o,p)},i.defineStaticLine=function(e){if(void 0!==e.slope&&void 0!==e.intercept)l={type:"slope-intercept",slope:e.slope,intercept:e.intercept};else if(e.point1&&e.point2){let[t,n]=e.point1,[o,r]=e.point2;if(t===o)l={type:"vertical",x:t};else{let e=(r-n)/(o-t);l={type:"slope-intercept",slope:e,intercept:n-e*t}}}else if(e.point&&void 0!==e.slope){let[t,n]=e.point,o=n-e.slope*t;l={type:"slope-intercept",slope:e.slope,intercept:o}}else{if(void 0===e.vertical)throw new Error("Invalid line definition format");l={type:"vertical",x:e.vertical}}},i.getCellsWithStaticLine=function(){if(!l)throw new Error("No static line defined. Call defineStaticLine() first.");let e=[];for(let n=0;n<t;++n)for(let t=0;t<o;++t){let o=a.BVH[n][t];v(o)&&e.push({i:n,j:t,cell:o})}return e},i.getPolylinesIntersectingStaticLine=function(){if(!l)throw new Error("No static line defined. Call defineStaticLine() first.");let e=new Set,t=i.getCellsWithStaticLine();for(let n of t){let t=n.cell;for(let[n,o]of t.data)if(!e.has(n))for(let t of o)if(y(t)){e.add(n);break}}return e},i.getDetailedStaticLineIntersections=function(){if(!l)throw new Error("No static line defined. Call defineStaticLine() first.");let e=[],t=i.getCellsWithStaticLine(),n=new Set;for(let o of t){let t=o.cell;for(let[r,i]of t.data)if(!n.has(r)){n.add(r);let t=[];for(let e=0;e<i.length;e++){let n=i[e];y(n)&&t.push({segmentIndex:e,segment:n,cellI:o.i,cellJ:o.j})}t.length>0&&e.push({polylineKey:r,intersections:t})}}return e},i.clearStaticLine=function(){l=null},i.getStaticLine=function(){return l},i.testStaticLineFunctionality=function(){if(l){console.log("🧪 Testing static line functionality..."),console.log("📏 Static line:",l);try{const e=i.getCellsWithStaticLine();console.log(`📦 Cells containing the line: ${e.length}`),console.log("📦 Cell positions:",e.map((e=>`(${e.i},${e.j})`)).join(", "));const t=i.getPolylinesIntersectingStaticLine();console.log(`🔗 Polylines intersecting: ${t.size}`),console.log("🔗 Intersecting polylines:",Array.from(t));const n=i.getDetailedStaticLineIntersections();console.log("📊 Detailed intersections:"),n.forEach((e=>{console.log(`  • ${e.polylineKey}: ${e.intersections.length} intersections`)})),console.log("✅ Static line functionality test completed!")}catch(e){console.error("❌ Error testing static line:",e.message)}}else console.log("❌ No static line defined")},i}function q(e){const t=document.createElement("template");return t.innerHTML=e,document.importNode(t.content,!0)}function Q(e){const t=document.createElementNS("http://www.w3.org/2000/svg","g");return t.innerHTML=e,t}const K=Object.assign(ye(q,(e=>{if(null===e.firstChild)return null;if(e.firstChild===e.lastChild)return e.removeChild(e.firstChild);const t=document.createElement("span");return t.appendChild(e),t})),{fragment:ye(q,(e=>e))});Object.assign(ye(Q,(e=>null===e.firstChild?null:e.firstChild===e.lastChild?e.removeChild(e.firstChild):e)),{fragment:ye(Q,(e=>{const t=document.createDocumentFragment();for(;e.firstChild;)t.appendChild(e.firstChild);return t}))});const J=60,Z=62,ee=47,te=45,ne=33,oe=61,re=10,ie=11,ae=12,le=13,se=14,ce=17,ue=22,de=23,he=26,fe="http://www.w3.org/2000/svg",pe="http://www.w3.org/1999/xlink",ge="http://www.w3.org/XML/1998/namespace",me="http://www.w3.org/2000/xmlns/",be=new Map(["attributeName","attributeType","baseFrequency","baseProfile","calcMode","clipPathUnits","diffuseConstant","edgeMode","filterUnits","glyphRef","gradientTransform","gradientUnits","kernelMatrix","kernelUnitLength","keyPoints","keySplines","keyTimes","lengthAdjust","limitingConeAngle","markerHeight","markerUnits","markerWidth","maskContentUnits","maskUnits","numOctaves","pathLength","patternContentUnits","patternTransform","patternUnits","pointsAtX","pointsAtY","pointsAtZ","preserveAlpha","preserveAspectRatio","primitiveUnits","refX","refY","repeatCount","repeatDur","requiredExtensions","requiredFeatures","specularConstant","specularExponent","spreadMethod","startOffset","stdDeviation","stitchTiles","surfaceScale","systemLanguage","tableValues","targetX","targetY","textLength","viewBox","viewTarget","xChannelSelector","yChannelSelector","zoomAndPan"].map((e=>[e.toLowerCase(),e]))),ve=new Map([["xlink:actuate",pe],["xlink:arcrole",pe],["xlink:href",pe],["xlink:role",pe],["xlink:show",pe],["xlink:title",pe],["xlink:type",pe],["xml:lang",ge],["xml:space",ge],["xmlns",me],["xmlns:xlink",me]]);function ye(e,t){return function({raw:n}){let o,r,i,a,l=1,s="",c=0;for(let e=0,t=arguments.length;e<t;++e){const t=n[e];if(e>0){const o=arguments[e];switch(l){case he:if(null!=o){const e=`${o}`;if(Be(r))s+=e.replace(/[<]/g,we);else{if(new RegExp(`</${r}[\\s>/]`,"i").test(s.slice(-r.length-2)+e))throw new Error("unsafe raw text");s+=e}}break;case 1:null==o||(o instanceof Node||"string"!=typeof o&&o[Symbol.iterator]||/(?:^|>)$/.test(n[e-1])&&/^(?:<|$)/.test(t)?(s+="\x3c!--::"+e+"--\x3e",c|=128):s+=`${o}`.replace(/[<&]/g,we));break;case 9:{let r;if(l=ae,/^[\s>]/.test(t)){if(null==o||!1===o){s=s.slice(0,i-n[e-1].length);break}if(!0===o||""==(r=`${o}`)){s+="''";break}if("style"===n[e-1].slice(i,a)&&ke(o)||"function"==typeof o){s+="::"+e,c|=1;break}}if(void 0===r&&(r=`${o}`),""===r)throw new Error("unsafe unquoted empty string");s+=r.replace(/^['"]|[\s>&]/g,we);break}case ae:s+=`${o}`.replace(/[\s>&]/g,we);break;case ie:s+=`${o}`.replace(/['&]/g,we);break;case re:s+=`${o}`.replace(/["&]/g,we);break;case 6:if(ke(o)){s+="::"+e+"=''",c|=1;break}throw new Error("invalid binding");case ce:break;default:throw new Error("invalid binding")}}for(let e=0,n=t.length;e<n;++e){const n=t.charCodeAt(e);switch(l){case 1:n===J&&(l=2);break;case 2:n===ne?l=25:n===ee?l=3:xe(n)?(o=e,r=void 0,l=4,--e):63===n?(l=5,--e):(l=1,--e);break;case 3:xe(n)?(l=4,--e):n===Z?l=1:(l=5,--e);break;case 4:Se(n)?(l=6,r=Ae(t,o,e)):n===ee?l=se:n===Z&&(r=Ae(t,o,e),l=Ce(r)?he:1);break;case 6:Se(n)||(n===ee||n===Z?(l=7,--e):n===oe?(l=8,i=e+1,a=void 0):(l=8,--e,i=e+1,a=void 0));break;case 8:Se(n)||n===ee||n===Z?(l=7,--e,a=e):n===oe&&(l=9,a=e);break;case 7:Se(n)||(n===ee?l=se:n===oe?l=9:n===Z?l=Ce(r)?he:1:(l=8,--e,i=e+1,a=void 0));break;case 9:Se(n)||(34===n?l=re:39===n?l=ie:n===Z?l=Ce(r)?he:1:(l=ae,--e));break;case re:34===n&&(l=le);break;case ie:39===n&&(l=le);break;case ae:Se(n)?l=6:n===Z&&(l=Ce(r)?he:1);break;case le:Se(n)?l=6:n===ee?l=se:n===Z?l=Ce(r)?he:1:(l=6,--e);break;case se:n===Z?l=1:(l=6,--e);break;case 5:n===Z&&(l=1);break;case 15:n===te?l=16:n===Z?l=1:(l=ce,--e);break;case 16:n===te?l=de:n===Z?l=1:(l=ce,--e);break;case ce:n===J?l=18:n===te&&(l=ue);break;case 18:n===ne?l=19:n!==J&&(l=ce,--e);break;case 19:n===te?l=20:(l=ce,--e);break;case 20:n===te?l=21:(l=de,--e);break;case 21:l=de,--e;break;case ue:n===te?l=de:(l=ce,--e);break;case de:n===Z?l=1:n===ne?l=24:n!==te&&(l=ce,--e);break;case 24:n===te?l=ue:n===Z?l=1:(l=ce,--e);break;case 25:n===te&&t.charCodeAt(e+1)===te?(l=15,++e):(l=5,--e);break;case he:n===J&&(l=27);break;case 27:n===ee?l=28:(l=he,--e);break;case 28:xe(n)?(o=e,l=29,--e):(l=he,--e);break;case 29:Se(n)&&r===Ae(t,o,e)?l=6:n===ee&&r===Ae(t,o,e)?l=se:n===Z&&r===Ae(t,o,e)?l=1:xe(n)||(l=he,--e);break;default:l=void 0}}s+=t}const u=e(s),d=document.createTreeWalker(u,c,null,!1),h=[];for(;d.nextNode();){const e=d.currentNode;switch(e.nodeType){case 1:{const t=e.attributes;for(let n=0,o=t.length;n<o;++n){const{name:r,value:i}=t[n];if(/^::/.test(r)){const t=arguments[+r.slice(2)];_e(e,r),--n,--o;for(const n in t){const o=t[n];null==o||!1===o||("function"==typeof o?e[n]=o:"style"===n&&ke(o)?Ee(e[n],o):Me(e,n,!0===o?"":o))}}else if(/^::/.test(i)){const t=arguments[+i.slice(2)];_e(e,r),--n,--o,"function"==typeof t?e[r]=t:Ee(e[r],t)}}break}case 8:if(/^::/.test(e.data)){const t=e.parentNode,n=arguments[+e.data.slice(2)];if(n instanceof Node)t.insertBefore(n,e);else if("string"!=typeof n&&n[Symbol.iterator])if(n instanceof NodeList||n instanceof HTMLCollection)for(let o=n.length-1,r=e;o>=0;--o)r=t.insertBefore(n[o],r);else for(const o of n)null!=o&&t.insertBefore(o instanceof Node?o:document.createTextNode(o),e);else t.insertBefore(document.createTextNode(n),e);h.push(e)}}}for(const e of h)e.parentNode.removeChild(e);return t(u)}}function we(e){return`&#${e.charCodeAt(0).toString()};`}function xe(e){return 65<=e&&e<=90||97<=e&&e<=122}function Se(e){return 9===e||10===e||12===e||32===e||13===e}function ke(e){return e&&e.toString===Object.prototype.toString}function Ce(e){return"script"===e||"style"===e||Be(e)}function Be(e){return"textarea"===e||"title"===e}function Ae(e,t,n){return e.slice(t,n).toLowerCase()}function Me(e,t,n){e.namespaceURI===fe&&(t=t.toLowerCase(),t=be.get(t)||t,ve.has(t))?e.setAttributeNS(ve.get(t),t,n):e.setAttribute(t,n)}function _e(e,t){e.namespaceURI===fe&&(t=t.toLowerCase(),t=be.get(t)||t,ve.has(t))?e.removeAttributeNS(ve.get(t),t):e.removeAttribute(t)}function Ee(e,t){for(const n in t){const o=t[n];n.startsWith("--")?e.setProperty(n,o):e[n]=o}}function Te({fmtX:e,fmtY:t,target:n,margin:o={top:0,left:0},callback:r=(()=>{})}){const i=K`<input class="x0" contenteditable="true"></input>`,a=K`<input class="y0" contenteditable="true"></input>`,l=K`<input class="x1" contenteditable="true"></input>`,s=K`<input class="y1" contenteditable="true"></input>`,c=e=>{function t(){this.style.width=this.value.length+1+"ch"}e.addEventListener("input",t),t.call(e)},u=()=>[i,a,l,s].map(c),d=K`<button>✅</button>`,h=K`<button>✅</button>`,f=K`<div style="position: absolute; top:0; left:0;">
    <div style="display:flex; position: absolute; bottom: 0px; right: 0px;">
      ${i}<strong> x </strong>${a} ${d}
    </div>
  </div>`,p=K`<div style="position: absolute; display:flex;">${l}<strong> x </strong>${s} ${h}</div>`,g=K`<div class="__ts_tooltip" style="display: none; z-index:2; position: absolute; top: ${o.top}px; left: ${o.left}px;">
    <style>
    div.__ts_tooltip { 
      font-family: sans-serif; font-size: 10pt; 
    }
    div.__ts_tooltip > div > div * { 
      margin-right: 1px;
    }
    div.__ts_tooltip div > button {
      padding: 0px;
      display: none;
    }
    div.__ts_tooltip div:hover > button {
      padding: 0px;
      display: block;
    }
    div.__ts_tooltip input {
      background-color:rgba(255, 255, 255, 0);    
      border: none;
      outline: none;
    }
    div.__ts_tooltip input:focus {
        border: solid #aaa;
    }


    </style>
    <div>${f}</div>
    <div>${p}</div>

  </div>`;function m(){g.value=[[i.value,a.value],[l.value,s.value]],g.dispatchEvent(new Event("input",{bubbles:!0})),r(g.value)}g.__update=({selection:n,selectionPixels:o})=>{g.style.display="block",i.value=e(n[0][0]),l.value=e(n[1][0]),a.value=t(n[0][1]),s.value=t(n[1][1]),u(),f.style.top=o[0][1]+"px",f.style.left=o[0][0]+"px",p.style.top=o[1][1]+"px",p.style.left=o[1][0]+"px"},g.__hide=()=>g.style.display="none",d.addEventListener("click",m),h.addEventListener("click",m);let b=n.getElementsByClassName("__ts_tooltip");return b.length>0&&n.removeChild(b[0]),n.appendChild(g),u(),g}function Ge({target:e,callback:t}){const n=K`<input type="radio" name="mode" id="__ts_c_intersect" value="intersect">`,o=K`<input type="radio" name="mode" id="__ts_c_contains" value="contains">`,r=K`<input type="checkbox"  id="__ts_c_not">`,i=K`<input type="radio" name="aggregation" id="__ts_c_and" value="and">`,a=K`<input type="radio" name="aggregation" id="__ts_c_or" value="or">`,l=K`<button style="position: absolute; right: 0; top: 0; padding: 0; margin: 0; border: none; background: none; cursor: pointer; font-size: 0.8rem; color: #444; line-height: 1; padding: 2px 2px;">&times;</button>`;let s;n.onchange=d,o.onchange=d,i.onchange=d,a.onchange=d,r.onchange=d;let c=K`<div class="__ts_contextMenu" style="display: none; z-index: 2; position: absolute" >
        ${l}
      
        <div class="__ts_option_label"><strong>Mode</strong></div>
        <div class="__ts_option_values">
          <div>
            ${n}
            <label for="__ts_c_intersect" title="Search for timelines that touch any part of the timebox">Intersect</label>
          </div>
          <div>
            ${o}
            <label for="__ts_c_contains" title="Search for timelines that are fully contained in the timebox">Contains</label>
          </div>
          <div>
            ${r}
            <label for="__ts_c_not" title=" ">Not</label>
          </div>
        </div>
      

      
        <div class="__ts_option_label"><strong>Aggregation</strong></div>
        <div class="__ts_option_values">
          <div>
            ${i}
            <label for="__ts_c_and">And</label>
          </div>
          <div>
            ${a}
            <label for="__ts_c_or">Or</label>
          </div>
        </div>
      
      

      <style> 
        .__ts_contextMenu { 
            border-radius: 3px;
            padding: 4px 14px 4px 4px;
            position: absolute; 
            width: max-content;
            background: #f6f6f6;
            opacity: 0.9;
            border: 1px solid #ccc; 
            font-family: sans-serif;
            font-size: 0.8rem;
            grid-template-columns: 1fr auto;
            grid-row-gap: 7px;
            box-shadow: 2px 2px 1px 0px #888888;
        }         

        .__ts_contextMenu  .__ts_option_values:hover { 
            background: #eee; 
        } 

        .__ts_contextMenu input[type="radio"] {
          margin-top: -1px;
          vertical-align: middle;
        }
      </style> 
    </div>`;e.appendChild(c);let u=null;function d(){let e=n.checked?H.Intersect:H.Contains,o=i.checked?F.And:F.Or,a=r.checked;t(e,o,a,s)}return c.onmouseleave=()=>u=setTimeout((()=>{c.__hide(),u=null}),1e3),c.onmouseenter=()=>{u&&clearTimeout(u),u=null},l.onclick=()=>c.__hide(),c.__hide=()=>c.style.display="none",c.__show=(e,t,l,u,d,h)=>{switch(s=h,e){case H.Intersect:n.checked=!0;break;case H.Contains:o.checked=!0;break;default:n.checked=!0,P("🚫 ERROR The method elected to compute the selection are not support")}switch(r.checked=l,t){case F.And:i.checked=!0;break;case F.Or:a.checked=!0;break;default:i.checked=!0,P("🚫 ERROR The aggregation method elected are not support")}c.style.display="grid",c.style.left=u+"px",c.style.top=d+"px"},c}return function(e,{target:t=document.createElement("div"),showBrushesControls:o=!0,showBrushTooltip:r=!0,showBrushesCoordinates:i=!0,showDetails:a=!0,x:l=(e=>e.x),y:s=(e=>e.y),id:c=(e=>e.id),color:d=null,referenceCurves:h=null,fmtX:f,fmtY:p=n.format(".1f"),stepX:g={days:10},stepY:m=1,xScale:b,yScale:v=n.scaleLinear(),xDomain:y,yDomain:w,yLabel:x="",xLabel:S="",xTicks:k,yTicks:C,filters:B=[],defaultAlpha:A=.7,selectedAlpha:M=1,noSelectedAlpha:_=.1,alphaScale:E=n.scalePow().exponent(.25).range([1,1]),backgroundColor:T="#ffffff",defaultColor:G="#aaa",selectedColor:N="#aaa",noSelectedColor:$="#dce0e5",colorScale:L=n.scaleOrdinal(n.schemeAccent),brushesColorScale:R=(d?n.scaleOrdinal(n.schemeGreys[3].toReversed()):n.scaleOrdinal(n.schemeTableau10)),selectedColorTransform:q=((e,t)=>n.color(e).darker(t)),width:Q=800,detailsWidth:K=400,height:J=600,detailsHeight:Z=300,detailsContainerHeight:ee=400,margin:te={left:50,top:30,bottom:50,right:50},detailsMargin:ne=null,updateCallback:oe=(()=>{}),statusCallback:re=(()=>{}),brushShadow:ie="drop-shadow( 2px 2px 2px rgba(0, 0, 0, .7))",showGroupMedian:ae=!0,hasDetails:le=!1,doubleYlegend:se=!1,showGrid:ce=!1,brushGroupSize:ue=15,maxDetailsRecords:de=10,maxTimelines:he=null,xPartitions:fe=10,yPartitions:pe=10,medianNumBins:ge=10,medianLineDash:me=[7],medianLineAlpha:be=1,medianLineWidth:ve=2,medianFn:ye=n.median,medianMinRecordsPerBin:we=5,autoUpdate:xe=!0,_this:Se,fixAxis:ke,groupAttr:Ce=null,overviewWidth:Be,overviewHeight:Ae,tsParent:Me,highlightAlpha:_e=1}={}){Q=Be||Q,J=Ae||J,ne=ne||te;let Ee,De,Ne,$e,Le,Ye,Re,Pe,je,Xe,ze,Oe,He,Fe,Ie,We,Ue,Ve,qe,Qe,Ke,Je,Ze,et,tt,nt,ot,rt,it,at,lt={},st=null;if(lt.xPartitions=fe,lt.yPartitions=pe,lt.defaultAlpha=A,lt.selectedAlpha=M,lt.noSelectedAlpha=_,lt.backgroundColor=T,lt.defaultColor=G,lt.selectedColor=N,lt.noSelectedColor=$,lt.hasDetails=le,lt.margin=te,lt.colorScale=L,lt.brushesColorScale=R,lt.color=d,lt.doubleYlegend=se,lt.showGrid=ce,lt.showBrushTooltip=r,lt.autoUpdate=xe,lt.brushGroupSize=ue,lt.stepX=g,lt.stepY=m,lt.medianLineAlpha=be,lt.medianLineWidth=ve,lt.medianLineDash=me,lt.medianNumBins=ge,lt.medianFn=ye,lt.alphaScale=E,lt.medianMinRecordsPerBin=we,lt.yScale=v,lt.xScale=b,lt.highlightAlpha=_e,lt.selectedColorTransform=q,Ce&&(console.warn('The attribute "groupAttr" is deprecated use "color" instead'),d=Ce),"string"==typeof l){let e=l;l=t=>t[e]}if("string"==typeof s){let e=s;s=t=>t[e]}if("string"==typeof c){let e=c;c=t=>t[e]}if(d&&"string"==typeof d){let e=d;d=t=>t[e]}function ct(e){return void 0!==rt||lt.brushesColorScale instanceof Array?lt.brushesColorScale[e](rt):lt.brushesColorScale(e)}function ut(){if(at.addBrushGroup(),nt){Ct(new CustomEvent("TimeWidget",{detail:{type:O.addBrushGroup}}))}}function dt(e){if(at.selectBrushGroup(e),nt){Ct(new CustomEvent("TimeWidget",{detail:{type:O.selectBrushGroup,data:e}}))}}function ht(e){if(nt){if(e){Ct(new CustomEvent("TimeWidget",{detail:{type:O.deselectAllBrushes}}))}let t;t=e?new CustomEvent("TimeWidget",{detail:{type:O.highlightSelection,data:{positionTs:rt,groupId:e[1].group}}}):new CustomEvent("TimeWidget",{detail:{type:O.highlightSelection}}),Ct(t)}}function ft(){n.select(ze).select("#brushesList").selectAll(".brushControl").data(at.getBrushesGroup(),(e=>e[0])).join("div").attr("class","brushControl").each((function(e,t,o){let r=o.length;const i=n.select(this);let a=e[1].name,l=qe.has(e[0])?qe.get(e[0]).length:0;i.node().innerHTML=`<div style="\n            display: flex;\n            flex-wrap: nowrap;\n            align-items: center;\n          ">\n            <input type="checkbox" id="checkBoxShowBrushGroup" ${e[1].isEnable?"checked":""} ></input>\n            <div\n              id="groupColor"\n              style="\n              min-width: ${lt.brushGroupSize}px;\n              width: ${lt.brushGroupSize}px;\n              height: ${lt.brushGroupSize}px;\n              background-color: ${ct(e[0])};\n              border-width: ${e[0]===at.getBrushGroupSelected()?2:0}px;\n              border-color: black;\n              border-style: solid;\n              margin-right: 5px;\n              cursor: pointer;\n            "></div>\n            <input\n              id="groupName"\n              style="margin-right: 5px; border: none;outline: none; width: ${a.length}ch;"\n              contenteditable="true"\n              value="${a}"></input>\n            <span id="groupSize" style="margin-right: 5px;">(${l})</span>\n           <button style="color: red;font-weight: bold; border:none; background:none;\n            display:${r>1?"block":"none"}" id="btnRemoveBrushGroup">&cross;</button>\n          </div>\n        `,i.select("input#groupName").on("input",(function(e){n.select(this).style("width",e.target.value.length+"ch")})),i.select("input#groupName").on("change",(t=>{n.select(this).style("width",t.target.value.length+"ch"),at.updateBrushGroupName(e[0],t.target.value),St()})),i.select("#btnRemoveBrushGroup").on("click",(t=>{t.stopPropagation(),function(e){at.removeBrushGroup(e),nt&&Ct(new CustomEvent("TimeWidget",{detail:{type:O.removeBrushGroup,data:e}}))}(e[0])})),i.select("#checkBoxShowBrushGroup").on("click",(e=>{e.stopPropagation()})),i.select("#checkBoxShowBrushGroup").on("change",(t=>{t.stopPropagation(),function(e,t){at.changeBrushGroupState(e,t),nt&&Ct(new CustomEvent("TimeWidget",{detail:{type:O.changeBrushGroupState,data:{id:e,newState:t}}}))}(e[0],t.target.checked),console.log("Should change state of brushesGroup "+e[0],t.target.checked)})),i.select("div#groupColor").on("click",(()=>dt(e[0]))),i.select("span#groupSize").on("click",(()=>dt(e[0])))})),n.select(ze).select("#brushesList").selectAll(".nonSelectedControl").remove(),n.select(ze).select("#brushesList").append("div").attr("class","nonSelectedControl").each((function(){const e=n.select(this);let t="Non selected",o=Qe.length;e.node().innerHTML=`<div style="\n            display: flex;\n            flex-wrap: nowrap;\n            align-items: center;\n            margin-bottom: 5px;\n          ">\n            <input type="checkbox" id="checkBoxShowBrushGroup" ${Ke?"checked":""} ></input>\n            <output\n              style="margin-right: 0; border: none;outline: none; width: ${t.length}ch;"\n              >${t}</output>\n            <span id="groupSize" style="margin-right: 5px;">(${o})</span>\n          </div>\n        `,e.select("#checkBoxShowBrushGroup").on("change",(e=>{var t;e.stopPropagation(),t=e.target.checked,Ke=t,nt&&Ct(new CustomEvent("TimeWidget",{detail:{type:O.changeNonSelected,data:{newState:t}}})),yt()}))})),He.selectAll(".colorBrushes").data(at.getBrushesGroup(),(e=>e[0])).join("rect").attr("class","colorBrushes").attr("id",(e=>"colorBrush-"+e[0])).attr("height",lt.brushGroupSize).attr("width",lt.brushGroupSize).attr("transform",((e,t)=>`translate(${90+t*(lt.brushGroupSize+5)}, -2)`)).style("stroke-width",(e=>e[0]===at.getBrushGroupSelected()?2:0)).style("stroke","black").style("fill",(e=>ct(e[0]))).on("click",(function(){dt(+n.select(this).attr("id").substr("11"))}))}function pt(){Pe=n.select(Re).selectAll("div#divData").data([1]).join("div").attr("id","divData"),Ye=n.select(Le).selectAll("div#render").data([1]).join("div").attr("id","render").style("position","relative").style("z-index",1),tt=W({ts:lt,element:Ye.node(),width:Q,height:J,x:l,y:s,groupAttr:d,overviewX:Ne,overviewY:$e}),Oe=Ye.selectAll("svg").data([1]).join("svg").attr("viewBox",[0,0,Q,J]).attr("height",J).attr("width",Q);const e=Oe.selectAll("g.gDrawing").data([1]).join("g").attr("class","gDrawing").attr("transform",`translate(${lt.margin.left}, ${lt.margin.top})`).attr("tabindex",0).style("pointer-events","all").style("outline","-webkit-focus-ring-color solid 0px").on("keydown",(e=>{switch(e.preventDefault(),e.key){case"r":case"Backspace":case"Delete":at.removeSelectedBrush();break;case"+":ut();break;case"ArrowRight":!function(){let e=at.getSelectedBrush();if(null===e)return;let[[t,n],[o,r]]=e[1].selectionDomain,i=Ne.domain()[1];if(Ze)if(o=u(o,lt.stepX),o>i){o=Y(o,lt.stepX);let e=D({start:o,end:i});o=i,t=u(t,e)}else t=u(t,lt.stepX);else if(o+=lt.stepX,o>i){let e=i-o+lt.stepX;o=i,t-=e}else t+=lt.stepX;at.moveSelectedBrush([[t,n],[o,r]],!0)}();break;case"ArrowLeft":!function(){let e=at.getSelectedBrush();if(null===e)return;let[[t,n],[o,r]]=e[1].selectionDomain,i=Ne.domain()[0];if(Ze)if(t=Y(t,lt.stepX),t<i){t=u(t,lt.stepX);let e=D({start:i,end:t});t=i,o=Y(o,e)}else o=Y(o,lt.stepX);else if(t-=lt.stepX,t<i){let e=t+lt.stepX-i;t=i,o-=e}else o-=lt.stepX;at.moveSelectedBrush([[t,n],[o,r]],!0)}();break;case"ArrowUp":!function(){let e=at.getSelectedBrush();if(null===e)return;let[[t,n],[o,r]]=e[1].selectionDomain;n+=lt.stepY;let i=$e.domain()[1];if(n>i){let e=i-n+lt.stepY;n=i,r+=e}else r+=lt.stepY;at.moveSelectedBrush([[t,n],[o,r]],!0)}();break;case"ArrowDown":!function(){let e=at.getSelectedBrush();if(null===e)return;let[[t,n],[o,r]]=e[1].selectionDomain;r-=lt.stepY;let i=$e.domain()[0];if(r<i){let e=r+lt.stepY-i;r=i,n-=e}else n-=lt.stepY;at.moveSelectedBrush([[t,n],[o,r]],!0)}();break;case"i":at.invertQuerySelectedGroup()}}));let t=n.axisLeft($e);C&&t.tickValues(C.map((e=>e[0]))).tickFormat(((e,t)=>C[t][1]?C[t][1]:C[t][0]));let r=e.selectAll("g.mainYAxis").data([1]).join("g").attr("class","mainYAxis").call(t).call((e=>e.selectAll("text.label").data([1]).join("text").text(x).attr("dy",-15).attr("class","label").style("fill","black").style("text-anchor","end").style("pointer-events","none"))).style("pointer-events","none");lt.doubleYlegend&&e.selectAll("g.secondYaxis").data([1]).join("g").attr("class","secondYaxis").call(n.axisRight($e)).attr("transform",`translate(${Q-lt.margin.left-lt.margin.right},0)`).style("pointer-events","none");let a=n.axisBottom(Ne||e);k&&a.tickValues(k.map((e=>e[0]))).tickFormat(((e,t)=>k[t][1]?k[t][1]:k[t][0]));let c=e.selectAll("g.mainXAxis").data([1]).join("g").attr("class","mainXAxis").call(a).attr("transform",`translate(0, ${J-lt.margin.top-lt.margin.bottom})`).call((e=>e.selectAll("text.label").data([1]).join("text").attr("class","label").text(S).attr("transform",`translate(${Q-lt.margin.right-lt.margin.left-5}, -10 )`).style("fill","black").style("text-anchor","end").style("pointer-events","none"))).style("pointer-events","none");return Ie=e.selectAll("g.gReferences").data([1]).join("g").attr("class","gReferences").style("pointer-events","none"),r.selectAll("g.tick").selectAll(".gridline").data(lt.showGrid?[1]:[]).join("line").attr("class","gridline").attr("x1",0).attr("y1",0).attr("x2",Q-lt.margin.right-lt.margin.left).attr("y2",0).attr("stroke","#9ca5aecf").attr("stroke-dasharray","4"),c.selectAll("g.tick").selectAll(".gridline").data(lt.showGrid?[1]:[]).join("line").attr("class","gridline").attr("x1",0).attr("y1",-J+lt.margin.top+lt.margin.bottom).attr("x2",0).attr("y2",0).attr("stroke","#9ca5aecf").attr("stroke-dasharray","4"),d&&(De.forEach((e=>Je.add(d(e)))),Je.size),He=Oe.selectAll("g.colorBrushes").data([1]).join("g").attr("class","colorBrushes").attr("transform",`translate(${lt.margin.left+10},${lt.margin.top-lt.brushGroupSize-5} )`),Fe=e.selectAll("g#brushes").data([1]).join("g").attr("id","brushes"),at=function({ts:e,data:t,element:o,tooltipTarget:r,contextMenuTarget:i,xPartitions:a,yPartitions:l,x:s,y:c,scaleX:u,scaleY:d,fmtX:h,fmtY:f,updateTime:p,brushShadow:g,minBrushSize:m=5,tsLevel:b,selectionCallback:v=(()=>{}),groupsCallback:y=(()=>{}),changeSelectedCoordinatesCallback:w=(()=>{}),selectedBrushCallback:x=(()=>{}),statusCallback:S=(()=>{})}){let k,C,B,A,M,_,E,T,G,D,N,$,L,Y,R,O={},I=0;if(!t)return;B=n.select(o),B.node().innerHTML="",A=U(p,te),M=U(p,se),_=U(50,be),E=U(50,ae),D=new Map,N=[],C=new Map,I=0,k=0;let W=t.map((e=>{let t=e[1].map((e=>[u(s(e)),d(c(e))]));return[e[0],t]}));function q([[e,t],[o,r]]){if(t=+t,r=+r,isNaN(+e)){let t=n.timeParse(h);e=t(e),o=t(o)}else e=+e,o=+o;O.moveBrush(R,[[e,t],[o,r]])}function Q(e,t,n,o){o[1].mode=e,o[1].aggregation=t,o[1].negate=n,de(o),ne()}$=V({data:W,xPartitions:a,yPartitions:l}),L=Te({fmtX:h,fmtY:f,target:r,margin:{top:e.margin.top,left:e.margin.left},callback:q}),Y=Ge({target:i,callback:Q});const K=(t,n)=>{if(P("💡  onBrushStart",n,arguments.length),!n||!n.length)return void P("🚫 ERRROR onBrushStart called with no or wrong brush",n);const[o,r]=n;o===I-1&&(k++,xe([o,r],T),C.get(T).isEnable=!0,G=[o,r],x(G),Se()),e.autoUpdate&&A(t,[o,r])};function J({selection:t,sourceEvent:n},o){if(void 0!==n){if(t){let[[r,i],[a,l]]=t;Math.abs(r-a)<m&&Math.abs(i-l)<m?oe(o):e.autoUpdate||(o[1].isSelected?se():te({selection:t,sourceEvent:n},o))}else oe(o);o[0]===I-1&&Z(),Se()}}function Z(t=H.Intersect,o=F.And,r=T,i){let a=n.brush().on("start",K);C.get(r).brushes.set(I,ke(a,t,o,r,null,null,i));let l=[I,C.get(T).brushes.get(I)];a.on("brush.move",ue),a.on("brush.Selected",E),e.autoUpdate&&a.on("brush.brushed",A),e.showBrushTooltip&&a.on("brush.show",(e=>_(e,l))),a.on("end",J),I++}function ee(e){return e.map((([e,t])=>[u.invert(e),d.invert(t)]))}function te({selection:e,sourceEvent:t},n){n[1]?void 0!==t&&e&&(n[1].selection=e,n[1].selectionDomain=ee(e),de(n)&&ne()):P("**🚫 ERROR brushed called without a brush[1]",n)}function ne(){if(N=[],D=new Map,C.forEach(((e,t)=>D.set(t,[]))),k>0)for(let e of t){let t=!1;for(let[n,o]of C.entries())le(e,o.brushes)&&(D.get(n).push(e),t=!0);t||N.push(e)}else N=t;v(D,N,0!==k)}function oe([e,t]){k--,C.get(t.group).brushes.delete(e),Se(),ne(),re(),L.__hide()}function re(){S()}function ie(){y(C)}function ae({selection:e}){let t=ee(e);w(t)}function le(e,t){if(0===t.size)return!1;if(1===t.size&&!t.values().next().value.intersections)return!1;let n=!0,o=!1;for(const r of t.values())if(r.intersections)switch(r.aggregation){case F.And:n=n&&r.intersections.has(e[0]),o=!0;break;case F.Or:if(r.intersections.has(e[0]))return!0}return n&&o}function se(){let e=!1;for(const t of C.values())for(const n of t.brushes)if(n[1].isSelected){let t=de(n);e=e||t}e&&ne()}function ce([e,t],n,o){let[[r,i],[a,l]]=t.selection;r+=n,a+=n,i+=o,l+=o,B.selectAll("#brush-"+e).call(t.brush.move,[[r,i],[a,l]]),t.selection=[[r,i],[a,l]],t.selectionDomain=ee(t.selection)}function ue({selection:t,sourceEvent:n},o){if(void 0===n)return;if(!Array.isArray(o)||2!==o.length)return void P("👁️ moveSelectedBrushes called without array trigger returning",o);const[r,i]=o;if(!t||!i.isSelected)return;let[[a,l]]=t,s=a-i.selection[0][0],c=l-i.selection[0][1];i.selection=t,i.selectionDomain=ee(t);for(const e of C.values())for(const[t,n]of e.brushes)n.isSelected&&r!==t&&ce([t,n],s,c);e.autoUpdate&&M()}function de([e,n]){let[[o,r],[i,a]]=n.selection,l=null;switch(n.mode){case H.Intersect:l=$.intersect(o,r,i,a);break;case H.Contains:l=$.contains(o,r,i,a);break;default:l=$.intersect(o,r,i,a),P("🚫 ERROR The method elected to compute the selection are not support, using default intersection instead ")}if(n.negate){let e=new Set(t.map((e=>e[0])));for(const t of l)e.delete(t);l=e}he();let s=!X(l,n.intersections);return n.intersections=l,s}function he(){B.selectAll(".brush").each((function([,e]){n.select(this).selectAll(".handle--w, .handle--e").style("fill",e.mode===H.Contains?j(we(e.group)):"none").style("opacity",.4),n.select(this).selectAll(".handle--n, .handle--s").style("fill",e.negate?"red":"none").style("opacity",.4),n.select(this).selectAll("title").data([0]).join("title").text(`Mode: ${e.mode===H.Contains?"Contains":"Intersect"}\nAggregation: ${e.aggregation===F.And?"And":"Or"}\nRight click for options`)}))}function fe(e){e[1].isSelected=!e[1].isSelected,ie(),x(e)}function pe(){for(let e of C.values())for(let t of e.brushes)t[1].isSelected=!1}function ge(){let e=Array.from(C.keys()).sort(),t=-1;for(let n of e){if(t+1!==n)break;t++}return t++,t}function me(e){return G&&e[0]===G[0]?g:""}function be({selection:e,sourceEvent:t},n){if(!e||void 0===t)return;let o=e.map((([e,t])=>[u.invert(+e),d.invert(+t)]));R=n,L.__update({selection:o,selectionPixels:e})}function ve(t){const o=t[1];n.select(this).selectAll(".selection").style("outline","-webkit-focus-ring-color solid 0px").style("fill",we(o.group)).style("stroke-width",o.group===T?"2px":"0.5px").style("stroke-dasharray",o.isSelected?"4":"").style("stroke",j(we(o.group))).style("outline-color",j(we(o.group))).style("fill",we(o.group)).attr("tabindex",0).on("mousedown",(e=>{0===e.button&&(ae({selection:o.selection}),G=G&&t[0]===G[0]?null:t,x(G),B.selectAll(".brush").style("-webkit-filter",me).style("filter",me),e.shiftKey&&fe(t))})).on("contextmenu",(e=>{e.preventDefault();let n=o.selection[0][0],r=o.selection[0][1];Y.__show(o.mode,o.aggregation,o.negate,n,r,t)})),e.showBrushTooltip&&n.select(this).selectAll(":not(.overlay)").on("mousemove",(e=>{be({selection:o.selection,sourceEvent:e},t)}))}function ye(e){T!==e&&(C.get(T).isActive=!1,pe(),C.get(),T=e,C.get(e).isActive=!0,C.get(e).isEnable=!0,Se())}function we(t){return void 0!==b||e.brushesColorScale instanceof Array?e.brushesColorScale[t](b):e.brushesColorScale(t)}function xe([e,t],n){C.get(t.group).brushes.delete(e),t.group=n,C.get(n).brushes.set(e,t)}function Se(){let e=[];C.forEach((t=>e=e.concat(Array.from(t.brushes)))),e.sort(((e,t)=>n.descending(e[0],t[0])));const t=B.selectAll(".brush").data(e,(e=>e[0])).join("g").attr("class","brush").attr("id",(([e])=>"brush-"+e)).each((function([,e]){return n.select(this).call(e.brush)})).style("-webkit-filter",me).style("filter",me).style("display",(e=>C.get(e[1].group).isEnable?"":"none")).style("pointer-events",(e=>e[1].group===T?"all":"none")).each(ve);t.each((function(e){n.select(this).selectAll(".overlay").style("pointer-events",(()=>I-1===e[0]?"all":"none"))})),t.each((function([e,t]){t.initialSelection&&(P("🎉 setting initial selection",t.initialSelection),n.select(this).selectAll(".selection").style("stroke",j(we(t.group))).style("outline-color",j(we(t.group))).style("fill",we(t.group)),O.moveBrush([e,t],t.initialSelection),t.initialSelection=void 0)}))}function ke(e,t,n,o,r,i,a){return{brush:e,intersections:null,mode:t,aggregation:n,negate:!1,isSelected:!1,group:o,selection:r,selectionDomain:i,initialSelection:a}}O.updateBrushGroupName=function(e,t){C.get(e).name=t,ie(),re()},O.addBrushGroup=function(){if(void 0!==b&&C.size===e.brushesColorScale.length)return void P("Another group cannot be added because there is no defined color family. ");let t=ge(),n={isEnable:!0,isActive:!1,name:"Group "+(t+1),brushes:new Map};C.set(t,n),D.set(t,[]),ye(t),v(D,N,0!==k),re(),ie()},O.changeBrushGroupState=function(e,t){C.get(e).isEnable!==t&&(C.get(e).isEnable=t,t||G&&G[1].group===e&&L.__hide(),Se(),re(),ie())},O.selectBrushGroup=function(e){ye(e),re(),ie()},O.getBrushesGroupSize=function(){return C.length},O.removeBrushGroup=function(e){if(C.length<=1)return;let t=C.keys(),n=t.next().value;n=n===e?t.next().value:n;let o=C.get(e);for(let[e,t]of o.brushes.entries())null!==t.selection?oe([e,t]):(t.group=n,C.get(n).brushes.set(e,t),o.brushes.delete(e));T===e&&(C.get(n).isActive=!0,T=n),C.delete(e),ie()},O.getEnableGroups=function(){let e=new Set;return C.forEach(((t,n)=>{t.isEnable&&e.add(n)})),e},O.getBrushesGroup=function(){let e=new Map;return C.forEach(((t,n)=>{let o=Object.assign({},t);o.brushes=new Map(t.brushes),e.set(n,o)})),e.forEach((e=>{e.brushes.forEach(((t,n)=>{null===t.selection&&e.brushes.delete(n)}))})),e},O.getBrushGroupSelected=function(){return T},O.removeSelectedBrush=function(){G&&oe(G)},O.getSelectedBrush=function(){return G},O.hasSelection=function(){return 0!==k},O.deselectBrush=function(){G&&(G=null,Se(),x(G))},O.changeSelectedBrushMode=function(e){G.mode=e,de(G)},O.changeSelectedBrushAggregation=function(e){G.aggregation=e,ne()},O.moveBrush=function([e,t],n,o=!1){let[[r,i],[a,l]]=n,s=u.domain()[0],c=u.domain()[1],h=d.domain()[0],f=d.domain()[1];r=Math.max(r,s),a=Math.min(a,c),i=Math.min(i,f),l=Math.max(l,h),s instanceof Date&&(r=new Date(r),a=new Date(a)),r>a&&([r,a]=[a,r]),i<l&&([i,l]=[l,i]);let p=u(r),g=u(a),m=d(i),b=d(l);B.selectAll("#brush-"+e).call(t.brush.move,[[p,m],[g,b]]),n=[[p,m],[g,b]];let v=[[r,i],[a,l]],y=new Event("move");o?ue({selection:n,sourceEvent:y},[e,t]):(te({selection:n,sourceEvent:y},[e,t]),L.__update({selection:v,selectionPixels:n}))},O.moveSelectedBrush=function([[e,t],[n,o]],r=!1){G?O.moveBrush(G,[[e,t],[n,o]],r):P("🚫 ERROR moveSelectedBrush called but selectedBrush is falsy ",G)},O.invertQuery=function(e){let t=C.get(e).brushes,n=Number.MAX_VALUE,o=Number.MIN_VALUE;t.forEach((e=>{e.selection&&(n=Math.min(e.selection[0][1],n),o=Math.max(e.selection[1][1],o))}));let r=(o-n)/2+n;t.forEach(((e,t)=>{if(!e.selection)return;let n=(e.selection[1][1]-e.selection[0][1])/2+e.selection[0][1];ce([t,e],0,2*(r-n))})),M()},O.invertQuerySelectedGroup=function(){O.invertQuery(T)},O.addFilters=function(e,t=!1){if(e instanceof Map&&(e=Array.from(e.values())).forEach((e=>e.brushes=Array.from(e.brushes.values()))),0!==e.length){t?C.clear():C.forEach((e=>{e.brushes.forEach(((t,n)=>{t.selection||e.brushes.delete(n)}))}));for(let t of e){let e=ge(),n={isEnable:!t.isEnable||t.isEnable,isActive:!!t.isActive&&t.isActive,name:t.name,brushes:new Map};C.set(e,n),D.set(e,[]);for(const n of t.brushes)z(n.selectionDomain,u,d)||(n.selection?n.selectionDomain=ee(n.selection):n.selectionDomain=ee([[0,100],[0,100]])),Z(n.mode,n.aggregation,e,n.selectionDomain),k++}Z(),ne(),Se()}},O.drawBrushes=function(){Se()},O.setTsPosition=function(e){b=e};let Ce=ge(),Be={isEnable:!0,isActive:!0,name:"Group "+(Ce+1),brushes:new Map};return C.set(Ce,Be),D.set(Ce,[]),T=Ce,C.get(Ce).isEnable=!0,Z(),Se(),O}({ts:lt,element:Fe.node(),data:Ee,tooltipTarget:Ye.node(),contextMenuTarget:Ye.node(),width:Q,height:J,xPartitions:fe,yPartitions:pe,x:l,y:s,brushShadow:ie,fmtY:p,fmtX:f,scaleX:Ne,scaleY:$e,updateTime:150,tsLevel:rt,selectionCallback:yt,groupsCallback:wt,changeSelectedCoordinatesCallback:gt,selectedBrushCallback:ht}),He.selectAll("text").data([1]).join("text").attr("x",0).attr("y",lt.brushGroupSize/2+2).text("Groups + : ").style("cursor","pointer").on("click",ut),Le.appendChild(Re),function(){je.innerHTML="";let e=n.select(je),t=e.append("div");t.append("span").text(S||"X Axis:");let o=t.append("div"),r=Ne.domain(),a=o.append("div").append("input").attr("type",Ze?"Date":"number").attr("min",Ze?f(r[0]):r[0]).attr("max",Ze?f(r[1]):r[1]).attr("step",lt.stepX).attr("width","50%").on("change",bt),l=o.append("div").append("input").attr("type",Ze?"Date":"number").attr("min",Ze?f(r[0]):r[0]).attr("max",Ze?f(r[1]):r[1]).attr("width","50%").attr("step",lt.stepX).on("change",bt),s=e.append("div");s.append("span").text(x||"Y Axis:");let c=s.append("div"),u=$e.domain(),d=c.append("div").append("input").attr("type","number").attr("min",u[0]).attr("max",u[1]).attr("width","50%").attr("step",lt.stepY).on("change",bt),h=c.append("div").append("input").attr("type","number").attr("min",u[0]).attr("max",u[1]).attr("width","50%").attr("step",lt.stepY).on("change",bt);st=[[a,d],[l,h]],i&&(e.insert("h3",":first-child").text("Current TimeBox Coordinates:"),Re.appendChild(je))}(),ze.innerHTML='<div style="flex-basis:100%;">\n    <div id="brushesList">\n    </div>\n    <button id="btnAddBrushGroup">Add Group</button>\n    </div>',ze.querySelector("button#btnAddBrushGroup").addEventListener("click",ut),o&&(n.select(ze).insert("h3",":first-child").text("Groups:"),Re.appendChild(ze)),e}function gt(e){!function(e){if(e){let[[t,n],[o,r]]=e;if(st){let[[e,i],[a,l]]=st;e.node().value=f(t),a.node().value=f(o),i.node().value=p(r).replace("−","-"),l.node().value=p(n).replace("−","-")}else P("updateBrushSpinBox called, but brushSpinBoxes not ready ",st)}else!function(){let[[e,t],[n,o]]=st;e.node().value="",n.node().value="",t.node().value="",o.node().value=""}()}(e),xt()}function mt(){if(d){Pe.node().innerHTML="",Pe.append("span").text("Data groups: ");let e=Pe.selectAll(".groupData").data(Je).join("div").attr("class","groupData");e.append("button").style("font-size",`${lt.brushGroupSize}px`).style("stroke","black").style("margin","2px").style("margin-right","10px").style("border-width","3px").style("border","solid black").style("width",`${lt.brushGroupSize}px`).style("height",`${lt.brushGroupSize}px`).style("background-color",(e=>lt.colorScale(e))).on("click",(function(e,t){Je.has(t)?(Je.delete(t),n.select(this).style("border","solid transparent")):(Je.add(t),n.select(this).style("border","solid black")),yt()})),e.append("span").text((e=>e))}}function bt(e){if(null===at.getSelectedBrush())return;let t,n,[[o,r],[i,a]]=st,l=Ne.domain(),s=+a.node().value,c=+r.node().value;Ze?(t=new Date(o.node().value),n=new Date(i.node().value),t>=n&&(e.target===o.node()?(n=u(t,lt.stepX),n=Math.min(n,l[1]),i.node().value=f(n)):(t=Y(n,lt.stepX),t=Math.max(t,l[0]),o.node().value=f(t)))):(t=+o.node().value,n=+i.node().value,t>=n&&(e.target===o.node()?(n=t+lt.stepX,i.node().value=n):(t=n-lt.stepX,o.node().value=t))),c>=s&&(e.target===r.node()?(s=c+lt.stepY,a.node().value=s):(c=s-lt.stepY,r.node().value=c)),at.moveSelectedBrush([[t,s],[n,c]])}function vt(e,t,n){let o=[],r=at.getEnableGroups();r.forEach((e=>{We.has(e)&&o.push([e,We.get(e)])}));let i=new Map,a=new Set(t);e.forEach(((e,t)=>{r.has(t)?i.set(t,e):e.forEach((e=>a.add(e)))}));let l=[];if(ot&&ot.forEach((e=>{if(e){let t=new Map;e.forEach(((e,n)=>{r.has(n)&&t.set(n,e)})),l.push(t)}else l.push(null)})),i.forEach((e=>a.delete(e))),t=Array.from(a),tt.render(i,at.getBrushGroupSelected(),Ke?t:[],o,n,l,rt,it),lt.hasDetails){let t=at.getBrushGroupSelected();window.requestAnimationFrame((()=>et.render({data:e,brushGroupSelected:t})))}}function yt(e=Ue,t=Ve,n=at.hasSelection(),o=!0){Ue=e,Ve=t,d?[qe,Qe]=function(e,t){let n=new Map(e),o=t;for(let e of n){let t=e[1].filter((e=>Je.has(d(e[1][0]))));n.set(e[0],t)}return o=o.filter((e=>Je.has(d(e[1][0])))),[n,o]}(Ue,Ve):(qe=Ue,Qe=Ve),nt&&({renderSelected:qe,renderNotSelected:Qe}=function(e,t){if(!ot||0===rt)return{renderSelected:e,renderNotSelected:t};let n,o=new Set,r=new Map;for(let e=rt-1;e>=0;e--)if(ot[e]){n=e;break}if(void 0!==n){ot[n].forEach(((e,t)=>{let n=new Set;e.forEach((e=>{n.add(e[0]),o.add(e[0])})),r.set(t,n)}));let i=new Map;e.forEach(((e,t)=>{if(r.has(t)){let n=e.filter((e=>r.get(t).has(e[0])));i.set(t,n)}else i.set(t,e)}));let a=t.filter((e=>o.has(e[0])));return{renderSelected:i,renderNotSelected:a}}return{renderSelected:e,renderNotSelected:t}}(qe,Qe)),ae&&function(e){if(!at.hasSelection())return;let t=+Ne.domain()[0],n=(+Ne.domain()[1]-t)/lt.medianNumBins;for(let o of e.entries()){let e=o[0],r=[],i=t;for(let e=0;e<lt.medianNumBins;++e)r.push({x0:i,x1:i+n,data:[]}),i+=n;for(let e of o[1])for(let o of e[1]){let e=Math.floor((l(o)-t)/n);e=e>lt.medianNumBins-1?e-1:e,r[e].data.push(s(o))}let a=[];for(let e of r)if(e.data.length>=lt.medianMinRecordsPerBin){let t=e.x0+(e.x1-e.x0)/2,n=lt.medianFn(e.data);a.push([t,n])}We.set(e,a)}P(" Bins computed",We)}(qe),vt(qe,Qe,n),ft(),St(qe),kt(qe,o)}function wt(){vt(qe,Qe,at.hasSelection()),ft(),St()}function xt(){let e=new Map;for(let[t,n]of at.getBrushesGroup()){let o={id:t,name:n.name,isActive:n.isActive,isEnable:n.isEnable,brushes:n.brushes};e.set(n.name,o)}Le.value.status=e,Le.dispatchEvent(new Event("input",{bubbles:!0}))}function St(e=qe){let t=new Map;for(let[n,o]of at.getBrushesGroup()){let r=new Map;e.get(n).forEach((e=>r.set(e[0],e[1]))),t.set(o.name,r)}Le.value=t,Le.value.groupsColorScale=R,Le.value.nonSelectedIds=Ve.map((e=>e[0])),Le.value.selectedIds=Ue.get(at.getBrushGroupSelected()).map((e=>e[0])),Le.value.selectedGroup=at.getBrushesGroup().get(at.getBrushGroupSelected()).name,Le.value.asArray=e=>function(e,{getRepresentative:t=(e=>e[0]),groupAttributeName:n="tw_group"}={}){return[...e.entries()].map((([e,o])=>[...o.values()].map((o=>{const r=t(o);return r[n]=e,r})))).flat()}(t,e),Le.extent={x:Ne.domain(),y:$e.domain()},Le.brushGroups=at.getBrushesGroup(),xt()}function kt(e,t){if(Ct(new CustomEvent("TimeWidget",{detail:{type:O.changeSelection,data:at.hasSelection()?e:null}})),t){Ct(new CustomEvent("TimeWidget",{detail:{type:O.update}}))}vt(qe,Qe,at.hasSelection())}function Ct(e){e.detail.sourceId=rt,nt&&nt.forEach(((t,n)=>{n!==rt&&t.dispatchEvent(e)}))}return Le=n.select(t).style("display","flex").style("flex-wrap","wrap").style("position","relative").style("top","0px").style("left","0px").style("background-color",lt.backgroundColor).node(),n.select(t).on("TimeWidget",(function(e){let t=e.detail;switch(P("customEvent","destination",rt,"source",t.sourceId,t.type),t.type){case O.changeSelection:ot[t.sourceId]=t.data;break;case O.update:n=t.sourceId,t.data,rt<=n?vt(qe,Qe,at.hasSelection()):yt(Ue,Ve,at.hasSelection(),!1);break;case O.addBrushGroup:at.addBrushGroup();break;case O.removeBrushGroup:at.removeBrushGroup(t.data);break;case O.selectBrushGroup:at.selectBrushGroup(t.data);break;case O.changeBrushGroupState:at.changeBrushGroupState(t.data.id,t.data.newState);break;case O.deselectAllBrushes:at.deselectBrush();break;case O.highlightSelection:it=t.data?{positionTs:t.data.positionTs,groupId:t.data.groupId}:null,vt(qe,Qe,at.hasSelection());break;case O.changeNonSelected:Ke=t.data.newState,yt();break;default:P("unsupported event",t)}var n})),n.select(t).on("input",(function(){P("Oninput test")})),Re=Re||n.select(t).select("#control").node()||n.create("div").attr("id","control").node(),je=je||n.select(t).select("#brushesCoordinates").node()||n.create("div").attr("id","brushesCoordinates").node(),ze=ze||n.select(t).select("#brushesGroups").node()||n.create("div").attr("id","brushesGroups").node(),We=new Map,Ue=new Map,Ve=[],Je=new Set,Ke=!0,ot=[],lt.addReferenceCurves=function(e){if(!Ne)return;if(!Array.isArray(e))throw new Error("The reference curves must be an array of Objects");let t=Ne.domain(),o=$e.domain();e.forEach((e=>{e.data.sort(((e,t)=>n.ascending(l(e),l(t)))),e.data=e.data.filter((e=>e[0]>=t[0]&&e[0]<=t[1]&&e[1]>=o[0]&&e[1]<=o[1]))}));let r=n.line().defined((e=>void 0!==e[1]&&null!==e[1])).x((e=>Ne(e[0]))).y((e=>$e(e[1])));Ie.selectAll(".referenceCurve").data(e).join("path").attr("class","referenceCurve").attr("d",(e=>r(e.data))).attr("stroke-width",2).style("fill","none").style("stroke",(e=>e.color)).style("opacity",(e=>e.opacity))},lt.updateCallback=function(e){return arguments.length?(oe=e,lt):oe},lt.statusCallback=function(e){return arguments.length?(re=e,lt):re},lt.notifyParent=function(e,n){return e.unshift(t),nt=Me?Me.notifyParent(e,n+1):e,rt=nt.length-1-n,at&&at.setTsPosition(rt),Ee&&kt(qe,!1),nt},lt.data=function(o){P(" Processing data: ... ",(e=o).length),De=e.filter((e=>void 0!==s(e)&&null!==s(e)&&void 0!==l(e)&&null!==l(e))),function({xDataType:e,fData:t}){y||(y=ke&&Se?Se.extent.x:n.extent(t,l)),Ne=b?b.copy():void 0,"object"===e&&l(t[0])instanceof Date?(Ze=!0,Ne||(Ne=n.scaleTime()),Ne.domain(y),f?"M"===f.name&&(console.log('👁️t has been detected that the parameter fmtX formats numerical data, while the data selected for the X-axis is a date. The function d3.timeFormat("%Y-%m-%d") will be used as fmtX; '),f=n.timeFormat("%Y-%m-%d")):f=n.timeFormat("%Y-%m-%d")):(Ne||(Ne=n.scaleLinear()),Ne.domain(y),f||(f=n.format(".1f"))),Ne.range([0,Q-lt.margin.right-lt.margin.left]).nice(),w||(w=ke&&Se?Se.extent.y:n.extent(t,s)),$e=v.copy(),$e.domain(w),$e.range([J-lt.margin.top-lt.margin.bottom,0]).nice().clamp(!0)}({xDataType:typeof l(De[0]),fData:De}),De=De.filter((e=>!isNaN(Ne(l(e)))&&!isNaN($e(s(e))))),Ee=n.groups(De,c),Ee.map((e=>[e[0],e[1].sort(((e,t)=>n.ascending(l(e),l(t))))])),lt.alphaScale.domain([0,Ee.length]),he&&(Ee=Ee.slice(0,he)),pt(),tt.setScales({scaleX:Ne,scaleY:$e}),tt.data(Ee),mt(),function({overviewX:e,overviewY:o}){lt.hasDetails&&(Xe||(Xe=n.select(t).select("#details").node()||n.create("div").attr("id","#details").node()),et=I({ts:lt,detailsElement:Xe,detailsContainerHeight:ee,detailsWidth:K,maxDetailsRecords:de,detailsHeight:Z,x:l,y:s,margin:ne}),et.setScales({overviewX:e,overviewY:o}),a&&Le.appendChild(Xe))}({overviewX:Ne,overviewY:$e}),Ue.set(0,[]),qe=Ue,Ve=Ee,Qe=Ve,Se?at.addFilters(Se.value.status,!0):B&&at.addFilters(B,!0),yt()},Me&&(lt.notifyParent([],0),ot[rt]=null),e&&l&&s&&c?lt.data(e):(Ne=n.scaleLinear().range([0,Q-lt.margin.right-lt.margin.left]),$e=n.scaleLinear().range([J-lt.margin.top-lt.margin.bottom,0]).nice().clamp(!0),pt()),h&&lt.addReferenceCurves(h),lt.render=()=>{yt()},Le.ts=lt,Le.details=Xe,Le.brushesCoordinates=je,Le.groups=ze,Le}}));
